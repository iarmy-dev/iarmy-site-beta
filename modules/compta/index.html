<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R√©glages Compta - iArmy</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23FF6B35'/><text x='50' y='68' font-family='Arial' font-size='55' font-weight='bold' fill='white' text-anchor='middle'>i</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #030303; color: white; min-height: 100vh; overflow-x: hidden; }
    .bg-gradient-animate { background: linear-gradient(135deg, #030303 0%, #0a0508 25%, #050808 50%, #080805 75%, #030303 100%); background-size: 400% 400%; animation: gradientShift 20s ease infinite; }
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    .orb { position: fixed; border-radius: 50%; filter: blur(100px); animation: float 15s ease-in-out infinite; pointer-events: none; z-index: 0; }
    .orb-1 { width: 500px; height: 500px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); top: -250px; right: -150px; opacity: 0.15; }
    .orb-2 { width: 400px; height: 400px; background: linear-gradient(135deg, #6B35FF, #8B5EFF); bottom: -200px; left: -150px; opacity: 0.12; animation-delay: -7s; }
    @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.05); } 66% { transform: translate(-20px, 20px) scale(0.95); } }

    .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
    .logo-i { width: 40px; height: 40px; background: linear-gradient(135deg, #FF6B35 0%, #FF8B5E 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; }
    .logo-i:hover { transform: scale(1.2) rotate(-15deg); box-shadow: 0 12px 40px rgba(255,107,53,0.6); }

    .nav-user-section { display: flex; align-items: center; gap: 12px; }
    .nav-profile { display: flex; align-items: center; gap: 10px; padding: 8px 16px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; text-decoration: none; color: white; font-weight: 500; }
    .nav-profile:hover { background: rgba(255,255,255,0.08); }
    .nav-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,107,53,0.3); }

    .page-container { max-width: 640px; margin: 0 auto; padding: 90px 20px 30px; position: relative; z-index: 10; }

    /* Loading */
    .loading-overlay { position: fixed; inset: 0; background: rgba(3,3,3,0.95); display: flex; align-items: center; justify-content: center; z-index: 100; }
    .loading-spinner { width: 28px; height: 28px; border: 2px solid rgba(255,107,53,0.2); border-top-color: #FF6B35; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Header page */
    .page-header { text-align: center; margin-bottom: 24px; }
    .page-title { font-size: 24px; font-weight: 700; margin-bottom: 6px; }
    .page-subtitle { font-size: 14px; color: rgba(255,255,255,0.7); }

    /* Preview Card */
    .preview-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 16px; margin-bottom: 20px; }
    .preview-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 12px 14px; color: white; font-size: 14px; font-family: inherit; margin-bottom: 12px; }
    .preview-input:focus { outline: none; border-color: #FF6B35; }
    .preview-input::placeholder { color: rgba(255,255,255,0.3); }
    .preview-row { display: grid; grid-template-columns: 1fr 1.5fr; gap: 12px; }
    .preview-box { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 12px; min-height: 80px; }
    .preview-label { font-size: 10px; color: rgba(255,255,255,0.7); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .preview-label-icon { font-size: 12px; }
    .tg-bubble { background: #2AABEE; padding: 10px 14px; border-radius: 14px 14px 14px 4px; font-size: 13px; display: inline-block; max-width: 100%; word-break: break-word; }
    .empty-state { color: rgba(255,255,255,0.25); font-size: 12px; }

    /* Mini Excel preview */
    .mini-excel-wrapper { position: relative; padding: 0 20px; }
    .mini-excel-container { overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; scroll-behavior: smooth; border-radius: 6px; }
    .mini-excel-container::-webkit-scrollbar { display: none; }
    .mini-excel { background: #1a472a; border-radius: 6px; overflow: hidden; font-size: 11px; display: inline-flex; flex-direction: column; min-width: 100%; }
    .mini-excel-header { display: flex; background: #0f9d58; }
    .mini-excel-header span { min-width: 40px; max-width: 50px; padding: 4px 5px; text-align: center; font-weight: 600; color: white; border-right: 1px solid rgba(255,255,255,0.2); font-size: 10px; white-space: nowrap; overflow: hidden; }
    .mini-excel-header span:last-child { border-right: none; }
    .mini-excel-row { display: flex; background: white; }
    .mini-excel-row span { min-width: 40px; max-width: 50px; padding: 4px 5px; text-align: center; color: #333; border-right: 1px solid #e0e0e0; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mini-excel-row span:last-child { border-right: none; }
    .mini-excel-row span.calculated { background: #e8f5e9; color: #2e7d32; font-weight: 600; }
    .mini-excel-row span.empty { color: #bbb; }
    .excel-nav { position: absolute; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; color: white; font-size: 14px; cursor: pointer; z-index: 5; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .excel-nav:hover { background: rgba(255,255,255,0.2); }
    .excel-nav.left { left: -6px; }
    .excel-nav.right { right: -6px; }
    .excel-nav:not(.visible) { display: none; }


    /* Rules detail */
    .preview-rules { margin-top: 10px; padding: 8px 10px; background: rgba(255,107,53,0.08); border-radius: 8px; font-size: 11px; color: rgba(255,255,255,0.6); }
    .preview-rules strong { color: #FF8B5E; }

    /* Section */
    .section { margin-bottom: 24px; }
    .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .section-title { font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.85); text-transform: uppercase; letter-spacing: 0.5px; }
    .section-count { font-size: 12px; color: rgba(255,255,255,0.5); }
    .section-badge { font-size: 10px; padding: 4px 8px; background: rgba(255,255,255,0.05); border-radius: 6px; color: rgba(255,255,255,0.6); margin-left: 6px; }

    /* Keywords grid - 2 colonnes */
    .kw-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .kw-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0.01) 100%);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 16px;
      position: relative;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }
    .kw-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #FF6B35, #FF8B5E);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .kw-card:hover {
      border-color: rgba(255,107,53,0.2);
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(255,107,53,0.1);
    }
    .kw-card:hover::before { opacity: 1; }
    .kw-card.incomplete { border-color: rgba(239,68,68,0.4); }
    .kw-card.incomplete::before { background: linear-gradient(90deg, #ef4444, #f87171); opacity: 1; }

    .kw-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .kw-name-input {
      background: none;
      border: none;
      color: white;
      font-weight: 700;
      font-size: 18px;
      width: 80px;
      font-family: inherit;
      letter-spacing: -0.5px;
    }
    .kw-name-input:focus { outline: none; }
    .kw-name-input::placeholder { color: rgba(255,255,255,0.2); }
    .kw-del {
      background: none;
      border: none;
      color: rgba(255,255,255,0.15);
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
      line-height: 1;
      transition: all 0.2s;
      border-radius: 6px;
    }
    .kw-del:hover { color: #ef4444; background: rgba(239,68,68,0.1); }

    .kw-mapping { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .kw-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .kw-chip-col {
      background: linear-gradient(135deg, rgba(255,107,53,0.2) 0%, rgba(255,107,53,0.1) 100%);
      border: 1px solid rgba(255,107,53,0.3);
      color: #FF8B5E;
    }
    .kw-chip-col:hover { background: rgba(255,107,53,0.25); }
    .kw-chip-col.empty {
      background: rgba(255,255,255,0.03);
      border: 1px dashed rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.4);
    }
    .kw-chip select {
      background: transparent;
      border: none;
      color: inherit;
      font-size: inherit;
      font-weight: inherit;
      font-family: inherit;
      cursor: pointer;
      padding-right: 4px;
    }
    .kw-chip select:focus { outline: none; }
    .kw-chip-icon { font-size: 10px; opacity: 0.7; }

    .kw-footer { margin-top: 10px; font-size: 10px; color: rgba(255,255,255,0.25); }

    /* Aliases tags */
    .kw-aliases { margin-top: 12px; }
    .kw-aliases-label { font-size: 10px; color: rgba(255,255,255,0.4); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .kw-aliases-list { display: flex; flex-wrap: wrap; gap: 6px; }
    .alias-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(34,197,94,0.15);
      border: 1px solid rgba(34,197,94,0.3);
      border-radius: 12px;
      font-size: 11px;
      color: #4ade80;
      transition: all 0.2s;
    }
    .alias-tag:hover { background: rgba(34,197,94,0.25); }
    .alias-tag-del {
      background: none;
      border: none;
      color: rgba(255,255,255,0.3);
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      padding: 0 2px;
      transition: color 0.2s;
    }
    .alias-tag-del:hover { color: #ef4444; }
    .alias-add {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: transparent;
      border: 1px dashed rgba(255,255,255,0.15);
      border-radius: 12px;
      font-size: 11px;
      color: rgba(255,255,255,0.4);
      cursor: pointer;
      transition: all 0.2s;
    }
    .alias-add:hover { border-color: #4ade80; color: #4ade80; }
    .alias-input {
      width: 120px;
      padding: 4px 8px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(34,197,94,0.3);
      border-radius: 12px;
      font-size: 11px;
      color: white;
      font-family: inherit;
    }
    .alias-input:focus { outline: none; border-color: #4ade80; }
    .alias-input::placeholder { color: rgba(255,255,255,0.3); }

    .btn-add-kw, .btn-add-rule {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: transparent;
      border: 1px dashed rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.2);
      font-size: 18px;
      font-weight: 300;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 12px auto 0;
    }
    .btn-add-kw:hover, .btn-add-rule:hover {
      border-color: rgba(255,255,255,0.25);
      color: rgba(255,255,255,0.5);
      transform: scale(1.05);
    }

    .btn-add { width: 100%; padding: 12px; background: transparent; border: 1px dashed rgba(255,255,255,0.1); border-radius: 10px; color: rgba(255,255,255,0.4); font-size: 13px; cursor: pointer; transition: all 0.2s; font-family: inherit; margin-top: 10px; }
    .btn-add:hover { border-color: #FF6B35; color: #FF8B5E; }

    /* Rules */
    .rule-card {
      background: linear-gradient(135deg, rgba(139,92,246,0.08) 0%, rgba(139,92,246,0.02) 100%);
      border: 1px solid rgba(139,92,246,0.15);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      position: relative;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .rule-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, #8B5CF6, #A78BFA);
      opacity: 0;
      transition: opacity 0.3s;
      border-radius: 16px 16px 0 0;
    }
    .rule-card:hover {
      border-color: rgba(139,92,246,0.3);
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(139,92,246,0.12);
    }
    .rule-card:hover::before { opacity: 1; }
    .rule-terms { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    .rule-select {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 8px 12px;
      color: white;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .rule-select:hover { border-color: rgba(139,92,246,0.4); }
    .rule-select:focus { outline: none; border-color: #8B5CF6; }
    .rule-op-select {
      background: linear-gradient(135deg, rgba(139,92,246,0.25) 0%, rgba(139,92,246,0.15) 100%);
      border: 1px solid rgba(139,92,246,0.4);
      border-radius: 8px;
      padding: 8px 10px;
      color: #A78BFA;
      font-size: 14px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      width: 44px;
      text-align: center;
    }
    .rule-op-select:focus { outline: none; }
    .rule-bottom { display: flex; align-items: center; gap: 10px; }
    .rule-arrow { color: #A78BFA; font-size: 14px; font-weight: 600; }
    .rule-add-term {
      background: rgba(255,255,255,0.03);
      border: 1px dashed rgba(255,255,255,0.15);
      border-radius: 8px;
      padding: 6px 10px;
      color: rgba(255,255,255,0.4);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .rule-add-term:hover { border-color: #8B5CF6; color: #A78BFA; }
    .rule-del-term {
      background: none;
      border: none;
      color: rgba(255,255,255,0.2);
      cursor: pointer;
      font-size: 14px;
      padding: 4px 6px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .rule-del-term:hover { color: #ef4444; background: rgba(239,68,68,0.1); }
    .rule-del-btn {
      background: none;
      border: none;
      color: rgba(255,255,255,0.15);
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
      line-height: 1;
      transition: all 0.2s;
      border-radius: 6px;
      margin-left: auto;
    }
    .rule-del-btn:hover { color: #ef4444; background: rgba(239,68,68,0.1); }

    /* Preview am√©lior√© */
    .preview-result { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.06); }
    .preview-calc { font-size: 12px; color: rgba(255,255,255,0.4); margin-bottom: 4px; }
    .preview-calc-result { color: #4ade80; font-weight: 600; }

    /* Connexions */
    .conn-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 12px 16px; margin-bottom: 8px; }
    .conn-label { font-size: 14px; color: rgba(255,255,255,0.9); }
    .conn-status { font-size: 13px; color: #4ade80; font-weight: 500; }
    .conn-status a { color: inherit; text-decoration: none; }
    .conn-status a:hover { text-decoration: underline; }
    .conn-status.pending { color: rgba(255,255,255,0.3); }

    /* Toggle switch */
    .toggle-active { background: #22C55E !important; }
    .toggle-dot-active { transform: translateX(20px); background: white !important; }

    /* Toast */
    .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%) translateY(-20px); padding: 12px 24px; background: #22C55E; border-radius: 12px; color: white; font-size: 14px; font-weight: 500; opacity: 0; transition: all 0.3s; z-index: 1000; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.error { background: #ef4444; }

    footer a { color: rgba(255,255,255,0.4); text-decoration: none; transition: color 0.2s; }
    footer a:hover { color: #FF8B5E; }
  </style>
</head>
<body class="bg-gradient-animate">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <div class="loading-overlay" id="loading">
    <div class="loading-spinner"></div>
  </div>

  <nav class="glass fixed top-0 left-0 right-0 z-50">
    <div class="max-w-3xl mx-auto px-5 py-4 flex items-center justify-between">
      <a href="../../compte/" class="flex items-center gap-3">
        <div class="logo-i">i</div>
        <span class="font-semibold text-lg">iArmy</span>
      </a>
      <div id="auth-section"></div>
    </div>
  </nav>

  <div class="page-container">
    <div class="page-header">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <a href="../../compte/" style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; color: rgba(255,255,255,0.6); text-decoration: none; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.08)';this.style.color='white'" onmouseout="this.style.background='rgba(255,255,255,0.04)';this.style.color='rgba(255,255,255,0.6)'">‚Üê</a>
          <div>
            <div class="page-title">Compta Express</div>
            <div class="page-subtitle">Configure ton robot</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Preview -->
    <div class="preview-card">
      <div class="preview-row">
        <div class="preview-box">
          <div class="preview-label"><span class="preview-label-icon">üí¨</span> Telegram</div>
          <div id="preview-tg"><span class="empty-state">Tape un message...</span></div>
        </div>
        <div class="preview-box">
          <div class="preview-label"><span class="preview-label-icon">üìä</span> Google Sheets</div>
          <div id="preview-sheet"><span class="empty-state">Preview Excel...</span></div>
        </div>
      </div>
      <div class="preview-rules" id="preview-rules" style="display: none;"></div>
      <div id="preview-links" style="display: none; margin-top: 10px; justify-content: center; gap: 16px;">
        <a id="sheet-link" href="#" target="_blank" style="color: rgba(255,255,255,0.4); font-size: 11px; text-decoration: none;">‚Üó Sheet</a>
        <a id="tg-link" href="https://t.me/IArmyBOT" target="_blank" style="color: rgba(255,255,255,0.4); font-size: 11px; text-decoration: none;">‚Üó Bot</a>
      </div>
    </div>

    <!-- Keywords -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">Mots-cles</div>
        <span class="section-count" id="kw-count">0</span>
      </div>
      <div class="kw-grid" id="kw-grid"></div>
      <button class="btn-add-kw" onclick="showAddKwWarning()" title="Ajouter un mot-cl√©">+</button>
      <div id="add-kw-hint" style="display: none; margin-top: 8px; padding: 10px 12px; background: rgba(255,107,53,0.1); border: 1px solid rgba(255,107,53,0.2); border-radius: 8px; font-size: 12px; color: rgba(255,255,255,0.6); position: relative;">
        <button onclick="closeAddKwHint()" style="position: absolute; top: 6px; right: 8px; background: none; border: none; color: rgba(255,255,255,0.4); cursor: pointer; font-size: 14px; padding: 0; line-height: 1;">√ó</button>
        üí° <strong>Avant d'ajouter</strong> : cr√©e d'abord la colonne dans ton <a href="#" id="hint-sheet-link" target="_blank" style="color: #4ade80;">Google Sheet</a>, puis reviens ici pour la linker.
      </div>
    </div>

    <!-- Rules -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">Regles<span class="section-badge">optionnel</span></div>
        <span class="section-count" id="rules-count">0</span>
      </div>
      <div id="rules-list"></div>
      <button class="btn-add-rule" onclick="addRule()" title="Ajouter une r√®gle">+</button>
    </div>

    <!-- Export Comptable -->
    <div class="section" id="export-section" style="margin-top: 28px; display: none;">
      <div class="section-header">
        <div class="section-title">Export Comptable</div>
      </div>

      <!-- Envoi automatique -->
      <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 14px; margin-bottom: 12px;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <div>
            <div style="font-size: 13px; font-weight: 600; color: white;">üìß Envoi automatique</div>
            <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px;">Envoie le PDF √† ta comptable chaque mois</div>
          </div>
          <label style="position: relative; width: 44px; height: 24px;">
            <input type="checkbox" id="auto-export-toggle" onchange="toggleAutoExport()" style="opacity: 0; width: 0; height: 0;">
            <span style="position: absolute; cursor: pointer; inset: 0; background: rgba(255,255,255,0.1); border-radius: 12px; transition: 0.3s;"></span>
            <span id="toggle-dot" style="position: absolute; left: 3px; top: 3px; width: 18px; height: 18px; background: rgba(255,255,255,0.4); border-radius: 50%; transition: 0.3s;"></span>
          </label>
        </div>
        <div id="auto-export-settings" style="display: none; margin-top: 14px; padding-top: 14px; border-top: 1px solid rgba(255,255,255,0.06);">
          <input type="email" id="export-email" placeholder="Email de ta comptable" style="width: 100%; padding: 10px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: white; font-size: 13px; margin-bottom: 10px;" oninput="updateEmailPreview()" onchange="saveAutoExportSettings()">
          <div style="display: flex; gap: 8px; margin-bottom: 10px;">
            <select id="auto-export-day" style="flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: white; font-size: 12px;" onchange="saveAutoExportSettings()">
              <option value="1">1er du mois</option>
              <option value="5">5 du mois</option>
            </select>
            <select id="auto-export-format" style="width: 80px; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: white; font-size: 12px;" onchange="saveAutoExportSettings()">
              <option value="pdf">PDF</option>
              <option value="xlsx">Excel</option>
            </select>
          </div>
          <!-- Colonnes √† inclure -->
          <div style="margin-bottom: 10px;">
            <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 8px;">Colonnes √† inclure :</div>
            <div id="export-columns-list" style="display: flex; flex-wrap: wrap; gap: 6px;">
              <!-- G√©n√©r√© dynamiquement -->
            </div>
          </div>
          <!-- Info Telegram -->
          <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 10px; padding: 8px 10px; background: rgba(255,255,255,0.02); border-radius: 6px;">
            üì± Tu recevras une validation sur Telegram avant l'envoi
          </div>
          <input type="hidden" id="require-telegram-confirm" value="true">
          <!-- Preview email -->
          <div style="margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px;">
            <div style="font-size: 10px; color: rgba(255,255,255,0.4); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Aper√ßu du mail</div>
            <div style="background: white; border-radius: 8px; padding: 12px; color: #333;">
              <div style="font-size: 10px; color: #666; margin-bottom: 8px;">
                <div>De: <span style="color: #333;">noreply@iarmy.fr</span></div>
                <div>√Ä: <span id="preview-to" style="color: #333;">comptable@...</span></div>
                <div>CC: <span id="preview-cc" style="color: #333;">toi</span></div>
              </div>
              <div style="border-top: 1px solid #eee; padding-top: 8px;">
                <div style="font-size: 11px; font-weight: 600; color: #333; margin-bottom: 6px;">üìé Compta <span id="preview-month">Janvier</span> 2026</div>
                <div id="preview-table" style="font-size: 10px; overflow-x: auto;">
                  <!-- Table preview generated by JS -->
                </div>
              </div>
            </div>
            <div style="font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 8px; text-align: center;">Aper√ßu simplifi√© ¬∑ Le vrai mail sera plus d√©taill√©</div>
          </div>
        </div>
      </div>

      <!-- Notifications Telegram (accord√©on) -->
      <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; overflow: hidden;">
        <div onclick="toggleNotifications()" style="padding: 14px; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
          <div>
            <div style="font-size: 13px; font-weight: 600; color: white;">üì± Notifications</div>
            <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px;">R√©caps automatiques sur Telegram</div>
          </div>
          <span id="notif-arrow" style="color: rgba(255,255,255,0.4); transition: transform 0.2s;">‚ñº</span>
        </div>
        <div id="notif-content" style="display: none; padding: 0 14px 14px; border-top: 1px solid rgba(255,255,255,0.06);">
          <!-- R√©cap hebdo -->
          <label style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.04); cursor: pointer;">
            <div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.9);">R√©cap hebdo</div>
              <div style="font-size: 10px; color: rgba(255,255,255,0.4);">Chaque lundi : total, meilleur jour, √©volution</div>
            </div>
            <input type="checkbox" id="notif-weekly-recap" onchange="saveNotificationSettings()" style="accent-color: #4ade80; width: 16px; height: 16px;">
          </label>

          <!-- R√©cap mensuel -->
          <label style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0; cursor: pointer;">
            <div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.9);">R√©cap mensuel</div>
              <div style="font-size: 10px; color: rgba(255,255,255,0.4);">Le 1er : bilan du mois + comparatif</div>
            </div>
            <input type="checkbox" id="notif-monthly-recap" onchange="saveNotificationSettings()" style="accent-color: #4ade80; width: 16px; height: 16px;">
          </label>

          <!-- Records -->
          <label style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-top: 1px solid rgba(255,255,255,0.04); cursor: pointer;">
            <div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.9);">üèÜ Records</div>
              <div style="font-size: 10px; color: rgba(255,255,255,0.4);">Notification quand tu bats un record</div>
            </div>
            <input type="checkbox" id="notif-records" onchange="saveNotificationSettings()" style="accent-color: #4ade80; width: 16px; height: 16px;">
          </label>

          <!-- Objectif mensuel -->
          <label style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-top: 1px solid rgba(255,255,255,0.04); cursor: pointer;">
            <div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.9);">üéØ Objectif mensuel</div>
              <div style="font-size: 10px; color: rgba(255,255,255,0.4);">Alerte quand tu atteins ton objectif</div>
            </div>
            <input type="checkbox" id="notif-objective" onchange="toggleObjectiveInput(); saveNotificationSettings()" style="accent-color: #4ade80; width: 16px; height: 16px;">
          </label>
          <div id="objective-input-row" style="display: none; padding: 8px 0 4px; border-top: 1px solid rgba(255,255,255,0.04);">
            <div style="display: flex; align-items: center; gap: 8px; justify-content: flex-end;">
              <input type="number" id="monthly-objective" placeholder="10000" min="0" step="100" onchange="saveNotificationSettings()" style="width: 100px; padding: 8px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-size: 13px; text-align: right;">
              <span style="color: rgba(255,255,255,0.5); font-size: 13px;">‚Ç¨</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Export manuel (accord√©on) -->
      <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; overflow: hidden;">
        <div onclick="toggleExportManual()" style="padding: 14px; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
          <div>
            <div style="font-size: 13px; font-weight: 600; color: white;">üì• Export manuel</div>
            <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px;">T√©l√©charge les donn√©es d'un mois</div>
          </div>
          <span id="export-manual-arrow" style="color: rgba(255,255,255,0.4); transition: transform 0.2s;">‚ñº</span>
        </div>
        <div id="export-manual-content" style="display: none; padding: 0 14px 14px; border-top: 1px solid rgba(255,255,255,0.06);">
          <div style="display: flex; gap: 8px; margin: 12px 0 10px;">
            <select id="export-month" style="flex: 1; padding: 10px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: white; font-size: 12px;">
              <!-- G√©n√©r√© dynamiquement par JS -->
            </select>
            <select id="export-year" style="width: 90px; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: white; font-size: 12px;" onchange="updateMonthOptions()">
              <!-- G√©n√©r√© dynamiquement par JS -->
            </select>
            <select id="export-format-manual" style="width: 80px; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: white; font-size: 12px;">
              <option value="pdf">PDF</option>
              <option value="xlsx">Excel</option>
            </select>
          </div>
          <div style="display: flex; gap: 8px; margin-bottom: 10px;">
            <button onclick="previewExport()" style="flex: 1; padding: 10px 16px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: rgba(255,255,255,0.8); font-size: 12px; font-weight: 500; cursor: pointer;">üëÅ Pr√©visualiser</button>
            <button onclick="exportDataManual()" style="flex: 1; padding: 10px 16px; background: linear-gradient(135deg, rgba(255,107,53,0.2) 0%, rgba(255,107,53,0.1) 100%); border: 1px solid rgba(255,107,53,0.3); border-radius: 8px; color: #FF8B5E; font-size: 12px; font-weight: 600; cursor: pointer;">üì• T√©l√©charger</button>
          </div>
          <!-- Export ann√©e compl√®te -->
          <button id="export-year-btn" onclick="exportFullYear()" disabled style="width: 100%; padding: 10px 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; color: rgba(255,255,255,0.3); font-size: 11px; font-weight: 500; cursor: not-allowed; transition: all 0.2s;">
            üìÖ Ann√©e compl√®te <span id="export-year-status">(disponible en d√©cembre)</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Lien discret pour nouveau fichier -->
    <div style="text-align: center; margin-top: 40px;">
      <button onclick="resetConfig()" style="background: none; border: none; color: rgba(255,255,255,0.25); font-size: 11px; cursor: pointer; padding: 8px 16px; transition: color 0.2s;" onmouseover="this.style.color='rgba(255,255,255,0.5)'" onmouseout="this.style.color='rgba(255,255,255,0.25)'">‚Üª Nouveau fichier</button>
    </div>
  </div>

  <footer style="padding: 32px 20px; background: rgba(0,0,0,0.3); border-top: 1px solid rgba(255,255,255,0.05); margin-top: 32px;">
    <div style="display: flex; justify-content: center; gap: 24px; font-size: 14px;">
      <a href="../../">Accueil</a>
      <a href="../../compte/">Compte</a>
      <a href="../../privacy/">Confidentialite</a>
      <a href="../../cgu/">CGU</a>
      <a href="mailto:support@iarmy.fr">Contact</a>
    </div>
    <p style="color: rgba(255,255,255,0.25); font-size: 12px; text-align: center; margin-top: 12px;">¬© 2026 iArmy</p>
  </footer>

  <div class="toast" id="toast"></div>

  <script>
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5cWZucGRjbmlmYXVod2dldGNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4ODY1MTIsImV4cCI6MjA4MzQ2MjUxMn0.1W2OaRb0sApMvrG_28AoV2zUFAzrptzpwbR1c65tOPo';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let config = null, keywords = [], rules = [], sheetHeaders = {}, exportSettings = {};
    let userEmail = '';
    const cols = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    let hasUnsavedChanges = false;

    // Nouveau format r√®gles: { terms: [{name, op}], target }
    // op: '+' ou '-' (premier terme toujours '+')

    async function init() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) { location.href = '../../'; return; }

      const user = session.user;
      userEmail = user.email || '';
      const userName = user.user_metadata?.full_name?.split(' ')[0] || user.user_metadata?.name?.split(' ')[0] || user.email?.split('@')[0] || 'User';
      const userAvatar = user.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${userName}&background=FF6B35&color=fff`;

      document.getElementById('auth-section').innerHTML = `
        <div class="nav-user-section">
          <a href="../../compte/" class="nav-profile">
            <img src="${userAvatar}" class="nav-avatar">
            <span>${userName}</span>
          </a>
        </div>
      `;

      // V√©rifier l'abonnement au module
      const hasAccess = await checkModuleAccess(user.id, 'compta');
      if (!hasAccess) {
        showNoAccessScreen();
        return;
      }

      await loadConfig(session.user.id);
      document.getElementById('loading').style.display = 'none';
    }

    async function checkModuleAccess(userId, moduleName) {
      try {
        const { data: sub } = await supabaseClient
          .from('subscriptions')
          .select('status, is_tester, expires_at')
          .eq('user_id', userId)
          .eq('module_name', moduleName)
          .single();

        if (!sub) return false;

        // Testeur = toujours acc√®s
        if (sub.is_tester) return true;

        // Status actif
        if (sub.status === 'active' || sub.status === 'tester') return true;

        // En essai et pas expir√©
        if (sub.status === 'trialing') {
          if (!sub.expires_at) return true;
          return new Date(sub.expires_at) > new Date();
        }

        // Annul√© mais p√©riode pas finie
        if (sub.status === 'canceled' && sub.expires_at) {
          return new Date(sub.expires_at) > new Date();
        }

        return false;
      } catch (e) {
        console.log('No subscription found, checking if table exists...');
        // Si la table n'existe pas encore, on laisse passer (pour la transition)
        return true;
      }
    }

    function showNoAccessScreen() {
      document.getElementById('loading').style.display = 'none';
      document.querySelector('.page-container').innerHTML = `
        <div style="text-align: center; padding: 60px 20px;">
          <div style="font-size: 48px; margin-bottom: 20px;">üîí</div>
          <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 12px;">Abonnement requis</h2>
          <p style="color: rgba(255,255,255,0.6); margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto;">
            Pour acc√©der au module Compta Express, tu dois avoir un abonnement actif ou √™tre en p√©riode d'essai.
          </p>
          <a href="../../compte/" style="display: inline-block; padding: 14px 28px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 12px; color: white; font-weight: 600; text-decoration: none; transition: all 0.3s;">
            Voir les abonnements
          </a>
          <p style="margin-top: 20px; font-size: 13px; color: rgba(255,255,255,0.4);">
            Un probl√®me ? <a href="mailto:support@iarmy.fr" style="color: #FF6B35;">Contacte-nous</a>
          </p>
        </div>
      `;
    }

    async function loadConfig(userId) {
      const { data: moduleConfig } = await supabaseClient.from('module_configs').select('sheet_id, config, created_at').eq('user_id', userId).eq('module_name', 'compta').single();

      if (!moduleConfig) { window.location.href = './setup/'; return; }

      const { data: tg } = await supabaseClient.from('telegram_links').select('telegram_user_id').eq('user_id', userId).maybeSingle();

      // Mapper pour compatibilit√© avec l'ancien format
      const cfg = {
        user_id: userId,
        sheet_id: moduleConfig.sheet_id,
        excel_config: moduleConfig.config,
        created_at: moduleConfig.created_at
      };
      config = cfg;
      config.createdYear = cfg.created_at ? new Date(cfg.created_at).getFullYear() : new Date().getFullYear();

      if (cfg?.excel_config?.colonnes_detectees) {
        cfg.excel_config.colonnes_detectees.forEach(c => {
          if (c.colonne && c.nom) sheetHeaders[c.colonne] = c.nom;
        });
      }

      keywords = (cfg?.excel_config?.colonnes_a_remplir || []).map(c => ({
        nom: c.nom,
        colonne: c.colonne || '',
        noteColumn: c.noteColumn || '',
        aliases: c.aliases || []
      }));

      // Convertir ancien format r√®gles vers nouveau
      rules = (cfg?.excel_config?.regles_calcul || []).map(r => {
        // Nouveau format avec terms
        if (r.terms && Array.isArray(r.terms)) {
          return { terms: r.terms, target: r.target || '' };
        }
        // Ancien format avec sources array
        if (r.sources && Array.isArray(r.sources)) {
          return {
            terms: r.sources.map((s, idx) => ({
              name: s,
              // operations[0] = entre source[0] et source[1], donc d√©calage de 1
              op: idx === 0 ? '+' : (r.operations && r.operations[idx - 1] ? r.operations[idx - 1] : '+')
            })),
            target: r.target || ''
          };
        }
        return { terms: [{ name: '', op: '+' }], target: '' };
      });

      // Ajouter mot-cl√© TOTAL automatiquement s'il n'existe pas (en dernier)
      const hasTotalColumn = keywords.some(k => k.nom && k.nom.toLowerCase() === 'total');
      if (!hasTotalColumn && keywords.length > 0) {
        // Chercher si une colonne du sheet s'appelle TOTAL
        let totalCol = '';
        for (const [col, name] of Object.entries(sheetHeaders)) {
          if (name && name.toLowerCase() === 'total') {
            totalCol = col;
            break;
          }
        }
        keywords.push({ nom: 'TOTAL', colonne: totalCol, noteColumn: '', aliases: ['total'] });
      }

      // S'assurer que TOTAL est en dernier
      const totalIdx = keywords.findIndex(k => k.nom && k.nom.toLowerCase() === 'total');
      if (totalIdx >= 0 && totalIdx !== keywords.length - 1) {
        const totalKw = keywords.splice(totalIdx, 1)[0];
        keywords.push(totalKw);
      }

      // Ajouter r√®gle TOTAL par d√©faut si absente
      const hasTotal = rules.some(r => r.target && r.target.toLowerCase() === 'total');
      if (!hasTotal && keywords.length > 1) {
        const otherColumns = keywords.filter(k => k.nom && k.nom.toLowerCase() !== 'total');
        if (otherColumns.length > 0) {
          rules.unshift({
            terms: otherColumns.map(k => ({ name: k.nom, op: '+' })),
            target: 'TOTAL'
          });
        }
      }

      render();

      if (cfg?.sheet_id) {
        const sheetUrl = `https://docs.google.com/spreadsheets/d/${cfg.sheet_id}/edit`;
        document.getElementById('export-section').style.display = 'block';
        document.getElementById('export-month').value = String(new Date().getMonth() + 1).padStart(2, '0');
        // Afficher les liens rapides
        document.getElementById('sheet-link').href = sheetUrl;
        document.getElementById('preview-links').style.display = 'flex';
      }

      // Charger les settings d'export
      exportSettings = cfg?.excel_config?.export_settings || {};
      loadExportSettings();
    }

    function loadExportSettings() {
      // Envoi automatique
      if (exportSettings.auto_export_enabled) {
        document.getElementById('auto-export-toggle').checked = true;
        document.getElementById('toggle-dot').classList.add('toggle-dot-active');
        document.getElementById('toggle-dot').previousElementSibling.classList.add('toggle-active');
        document.getElementById('auto-export-settings').style.display = 'block';
      }
      if (exportSettings.export_email) {
        document.getElementById('export-email').value = exportSettings.export_email;
      }
      if (exportSettings.auto_export_day) {
        document.getElementById('auto-export-day').value = exportSettings.auto_export_day;
      }
      if (exportSettings.auto_export_format) {
        document.getElementById('auto-export-format').value = exportSettings.auto_export_format;
      }

      // Confirmation Telegram toujours activ√©e
      document.getElementById('require-telegram-confirm').value = 'true';

      // Notifications Telegram
      document.getElementById('notif-monthly-recap').checked = exportSettings.notif_monthly_recap || false;
      document.getElementById('notif-weekly-recap').checked = exportSettings.notif_weekly_recap || false;
      document.getElementById('notif-records').checked = exportSettings.notif_records || false;
      document.getElementById('notif-objective').checked = exportSettings.notif_objective || false;
      document.getElementById('monthly-objective').value = exportSettings.monthly_objective || '';
      if (exportSettings.notif_objective) {
        document.getElementById('objective-input-row').style.display = 'block';
      }

      // G√©n√©rer les checkboxes des colonnes
      renderExportColumns();

      // Initialiser les s√©lecteurs mois/ann√©e
      initExportSelects();
    }

    function renderExportColumns() {
      const container = document.getElementById('export-columns-list');
      if (!container) return;

      // Colonnes de base toujours pr√©sentes
      const baseColumns = [
        { id: 'date', nom: 'Date', checked: true }
      ];

      // Colonnes des mots-cl√©s configur√©s
      const kwColumns = keywords.filter(k => k.nom && k.colonne).map(k => ({
        id: k.nom.toLowerCase(),
        nom: k.nom,
        checked: exportSettings.export_columns ? exportSettings.export_columns.includes(k.nom) : true
      }));

      // Colonnes calcul√©es
      const calcColumns = [
        { id: 'total', nom: 'TOTAL', checked: exportSettings.export_columns ? exportSettings.export_columns.includes('TOTAL') : true },
        { id: 'tva', nom: 'TVA', checked: exportSettings.export_columns ? exportSettings.export_columns.includes('TVA') : true }
      ];

      const allColumns = [...baseColumns, ...kwColumns, ...calcColumns];

      // Si pas de settings sauvegard√©s, tout coch√© par d√©faut
      if (!exportSettings.export_columns) {
        allColumns.forEach(c => c.checked = true);
      }

      container.innerHTML = allColumns.map(col => `
        <label style="display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; cursor: pointer; font-size: 12px;">
          <input type="checkbox" class="export-col-checkbox" data-col="${col.nom}" ${col.checked ? 'checked' : ''} onchange="saveAutoExportSettings(); updateEmailPreview();" style="accent-color: #FF6B35;">
          <span>${col.nom}</span>
        </label>
      `).join('');

      // Update preview after rendering
      updateEmailPreview();
    }

    function toggleNotifications() {
      const content = document.getElementById('notif-content');
      const arrow = document.getElementById('notif-arrow');
      const isOpen = content.style.display !== 'none';

      content.style.display = isOpen ? 'none' : 'block';
      arrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
    }

    function toggleExportManual() {
      const content = document.getElementById('export-manual-content');
      const arrow = document.getElementById('export-manual-arrow');
      const isOpen = content.style.display !== 'none';

      content.style.display = isOpen ? 'none' : 'block';
      arrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
    }

    function initExportSelects() {
      const yearSelect = document.getElementById('export-year');
      const currentYear = new Date().getFullYear();
      const createdYear = config?.createdYear || currentYear;

      // G√©n√©rer les ann√©es disponibles (de l'ann√©e en cours jusqu'√† l'ann√©e de cr√©ation)
      let yearsHtml = '';
      for (let y = currentYear; y >= createdYear; y--) {
        yearsHtml += `<option value="${y}">${y}</option>`;
      }

      yearSelect.innerHTML = yearsHtml;

      updateMonthOptions();
      updateYearExportButton();

      // Mettre √† jour quand on change d'ann√©e
      yearSelect.addEventListener('change', () => {
        updateMonthOptions();
        updateYearExportButton();
      });
    }

    function updateYearExportButton() {
      const selectedYear = parseInt(document.getElementById('export-year').value);
      const currentYear = new Date().getFullYear();
      const currentMonth = new Date().getMonth(); // 0-indexed

      const yearBtn = document.getElementById('export-year-btn');
      const yearStatus = document.getElementById('export-year-status');

      // Actif si : ann√©e pass√©e OU d√©cembre de l'ann√©e en cours
      const isEnabled = (selectedYear < currentYear) || (selectedYear === currentYear && currentMonth === 11);

      if (isEnabled) {
        yearBtn.disabled = false;
        yearBtn.style.background = 'rgba(74, 222, 128, 0.1)';
        yearBtn.style.borderColor = 'rgba(74, 222, 128, 0.2)';
        yearBtn.style.color = '#4ade80';
        yearBtn.style.cursor = 'pointer';
        yearStatus.textContent = '';
      } else {
        yearBtn.disabled = true;
        yearBtn.style.background = 'rgba(255,255,255,0.02)';
        yearBtn.style.borderColor = 'rgba(255,255,255,0.05)';
        yearBtn.style.color = 'rgba(255,255,255,0.3)';
        yearBtn.style.cursor = 'not-allowed';
        const monthsLeft = 11 - currentMonth;
        yearStatus.textContent = `(dans ${monthsLeft} mois)`;
      }
    }

    async function exportFullYear() {
      if (!config?.sheet_id) { toast('Aucun fichier configur√©', true); return; }

      const year = document.getElementById('export-year').value;
      toast('Export de l\'ann√©e en cours...');

      try {
        const { data: { session }, error: sessionError } = await supabaseClient.auth.refreshSession();
        if (sessionError || !session?.access_token) {
          toast('Session expir√©e, reconnecte-toi', true);
          return;
        }

        // Charger SheetJS
        if (typeof XLSX === 'undefined') {
          toast('Chargement...');
          await loadScript('https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js');
        }

        const wb = XLSX.utils.book_new();
        const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
        let hasData = false;

        // R√©cup√©rer chaque mois
        for (let i = 0; i < 12; i++) {
          const sheetName = `${monthNames[i]} ${year}`;
          toast(`Lecture ${monthNames[i]}...`);

          try {
            const res = await fetch(SUPABASE_URL + '/functions/v1/read-google-sheet', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.access_token, 'apikey': SUPABASE_ANON_KEY },
              body: JSON.stringify({ sheetId: config.sheet_id, sheetName: sheetName })
            });
            const result = await res.json();

            if (result.success && result.data?.length > 0) {
              const ws = XLSX.utils.aoa_to_sheet(result.data);
              XLSX.utils.book_append_sheet(wb, ws, monthNames[i]);
              hasData = true;
            }
          } catch (e) {
            console.log(`Pas de donn√©es pour ${sheetName}`);
          }
        }

        if (!hasData) {
          toast('Aucune donn√©e pour cette ann√©e', true);
          return;
        }

        XLSX.writeFile(wb, `compta_${year}_complet.xlsx`);
        toast('Export ann√©e termin√© !');

      } catch (err) {
        console.error('Export year error:', err);
        toast('Erreur: ' + err.message, true);
      }
    }

    function updateMonthOptions() {
      const monthSelect = document.getElementById('export-month');
      const yearSelect = document.getElementById('export-year');
      const selectedYear = parseInt(yearSelect.value);
      const currentYear = new Date().getFullYear();
      const currentMonth = new Date().getMonth(); // 0-indexed

      const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

      let options = '';
      const maxMonth = (selectedYear === currentYear) ? currentMonth : 11;

      for (let i = maxMonth; i >= 0; i--) {
        const value = String(i + 1).padStart(2, '0');
        const selected = (i === maxMonth) ? 'selected' : '';
        options += `<option value="${value}" ${selected}>${monthNames[i]}</option>`;
      }

      monthSelect.innerHTML = options;
    }

    function updateEmailPreview() {
      const emailInput = document.getElementById('export-email');
      const previewTo = document.getElementById('preview-to');
      const previewCc = document.getElementById('preview-cc');
      const previewTable = document.getElementById('preview-table');

      if (!previewTo || !previewTable) return;

      // Update recipient
      const email = emailInput?.value || '';
      previewTo.textContent = email || 'comptable@...';

      // Update CC with user's email
      if (previewCc) {
        previewCc.textContent = userEmail || 'ton email';
      }

      // Get checked columns
      const checkedCols = [];
      document.querySelectorAll('.export-col-checkbox:checked').forEach(cb => {
        checkedCols.push(cb.dataset.col);
      });

      if (checkedCols.length === 0) {
        previewTable.innerHTML = '<div style="color: #999; font-style: italic;">S√©lectionne des colonnes</div>';
        return;
      }

      // Generate mini table preview with example data
      const exampleData = {
        'Date': '15/01',
        'CB': '245',
        'ESP': '180',
        'TR': '95',
        'DEP': '45',
        'RAZ': '520',
        'TOTAL': '520',
        'TVA': '52'
      };

      // Fill missing columns with random values
      checkedCols.forEach(col => {
        if (!exampleData[col]) {
          exampleData[col] = String(Math.floor(Math.random() * 200) + 50);
        }
      });

      const headerRow = checkedCols.map(c => `<th style="padding: 4px 8px; background: #0f9d58; color: white; font-size: 9px; white-space: nowrap;">${c}</th>`).join('');
      const dataRow = checkedCols.map(c => `<td style="padding: 4px 8px; border: 1px solid #e0e0e0; font-size: 9px; text-align: center;">${exampleData[c] || '-'}</td>`).join('');

      previewTable.innerHTML = `
        <table style="border-collapse: collapse; width: 100%; margin-top: 4px;">
          <tr>${headerRow}</tr>
          <tr>${dataRow}</tr>
          <tr style="color: #999;">${checkedCols.map(() => '<td style="padding: 2px 8px; font-size: 8px; text-align: center;">...</td>').join('')}</tr>
        </table>
      `;
    }

    function render() {
      renderKw();
      renderRules();
      updatePreview();
      updateCounts();
      updatePlaceholder();
    }

    function updatePlaceholder() {
      // Plus d'input de test, fonction simplifi√©e
    }

    function updateCounts() {
      const validKw = keywords.filter(k => k.nom && k.colonne).length;
      const validRules = rules.filter(r => r.terms.some(t => t.name) && r.target).length;
      document.getElementById('kw-count').textContent = validKw;
      document.getElementById('rules-count').textContent = validRules;
    }

    function renderKw() {
      document.getElementById('kw-grid').innerHTML = keywords.map((k, i) => {
        const incomplete = k.nom && !k.colonne;
        const colHeader = k.colonne && sheetHeaders[k.colonne] ? sheetHeaders[k.colonne] : null;

        // Aliases (exclure le nom lui-m√™me s'il est dans les aliases)
        const aliases = (k.aliases || []).filter(a => a && a.toLowerCase() !== k.nom.toLowerCase());

        return `
        <div class="kw-card ${incomplete ? 'incomplete' : ''}">
          <div class="kw-header">
            <input class="kw-name-input" value="${k.nom}" onchange="updKw(${i},'nom',this.value)" oninput="this.value=this.value.substring(0,20)" maxlength="20" placeholder="NOM">
            <button class="kw-del" onclick="delKw(${i})" title="Supprimer">√ó</button>
          </div>
          <div class="kw-mapping">
            <div class="kw-chip kw-chip-col ${!k.colonne ? 'empty' : ''}">
              <span class="kw-chip-icon">‚Üí</span>
              <select onchange="updKw(${i},'colonne',this.value)">
                <option value="">Colonne</option>
                ${cols.map(c => `<option value="${c}" ${k.colonne === c ? 'selected' : ''}>${c}${sheetHeaders[c] ? ' ¬∑ ' + sheetHeaders[c] : ''}</option>`).join('')}
              </select>
            </div>
          </div>
          <div class="kw-aliases">
            <div class="kw-aliases-label">Mots-cl√©s</div>
            <div class="kw-aliases-list">
              ${aliases.map((a, j) => `
                <span class="alias-tag">
                  ${a}
                  <button class="alias-tag-del" onclick="delAlias(${i},${j})" title="Supprimer">√ó</button>
                </span>
              `).join('')}
              <button class="alias-add" onclick="showAliasInput(${i})" id="alias-add-${i}">+ Ajouter</button>
              <input type="text" class="alias-input" id="alias-input-${i}" style="display:none" placeholder="ex: ticket resto" onkeydown="if(event.key==='Enter'){addAlias(${i});}" onblur="addAlias(${i})">
            </div>
          </div>
          ${colHeader ? `<div class="kw-footer">Colonne "${colHeader}"</div>` : ''}
        </div>
      `}).join('');
    }

    function renderRules() {
      const names = keywords.map(k => k.nom).filter(n => n);

      document.getElementById('rules-list').innerHTML = rules.map((r, i) => {
        const termsHtml = r.terms.map((t, j) => {
          const opHtml = j > 0 ? `
            <select class="rule-op-select" onchange="updRuleTerm(${i},${j},'op',this.value)">
              <option value="+" ${t.op === '+' ? 'selected' : ''}>+</option>
              <option value="-" ${t.op === '-' ? 'selected' : ''}>‚àí</option>
            </select>
          ` : '';

          return `
            ${opHtml}
            <select class="rule-select" onchange="updRuleTerm(${i},${j},'name',this.value)">
              <option value="">...</option>
              ${names.map(n => `<option value="${n}" ${t.name === n ? 'selected' : ''}>${n}</option>`).join('')}
            </select>
            ${r.terms.length > 2 ? `<button class="rule-del-term" onclick="delRuleTerm(${i},${j})">√ó</button>` : ''}
          `;
        }).join('');

        return `
          <div class="rule-card">
            <div class="rule-terms">
              ${termsHtml}
              <button class="rule-add-term" onclick="addRuleTerm(${i})">+</button>
            </div>
            <div class="rule-bottom">
              <span class="rule-arrow">=</span>
              <select class="rule-select" onchange="updRuleTarget(${i},this.value)">
                <option value="">cible</option>
                ${names.map(n => `<option value="${n}" ${r.target === n ? 'selected' : ''}>${n}</option>`).join('')}
              </select>
              <button class="rule-del-btn" onclick="delRule(${i})" title="Supprimer">√ó</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Keywords
    let addKwWarningShown = false;

    function showAddKwWarning() {
      const hint = document.getElementById('add-kw-hint');
      const hintLink = document.getElementById('hint-sheet-link');
      const btn = document.querySelector('.btn-add-kw');

      if (!addKwWarningShown) {
        // Premier clic : afficher le hint
        hint.style.display = 'block';
        if (config?.sheet_id) {
          hintLink.href = `https://docs.google.com/spreadsheets/d/${config.sheet_id}/edit`;
        }
        addKwWarningShown = true;
        btn.style.borderColor = 'rgba(74,222,128,0.4)';
        btn.style.color = 'rgba(74,222,128,0.6)';
      } else {
        // Deuxi√®me clic : ajouter le mot-cl√©
        addKw();
        closeAddKwHint();
        btn.style.borderColor = '';
        btn.style.color = '';
      }
    }

    function closeAddKwHint() {
      document.getElementById('add-kw-hint').style.display = 'none';
      addKwWarningShown = false;
      document.querySelector('.btn-add').textContent = '+ Ajouter un mot-cl√©';
    }

    function addKw() {
      // Trouver la prochaine colonne libre :
      // - Pas d√©j√† utilis√©e par un mot-cl√©
      // - Pas d√©j√† occup√©e dans le Sheet (sheetHeaders)
      const usedCols = keywords.map(k => k.colonne).filter(c => c);
      const sheetCols = Object.keys(sheetHeaders); // Colonnes qui ont d√©j√† un header dans le Sheet
      let nextCol = '';
      for (const col of cols) {
        if (!usedCols.includes(col) && !sheetCols.includes(col) && col !== 'A') {
          nextCol = col;
          break;
        }
      }
      keywords.push({ nom: '', colonne: nextCol, noteColumn: '', aliases: [] });
      render();
      markAsModified();
    }
    // Aliases par d√©faut selon le nom du mot-cl√©
    function getDefaultAliases(name) {
      const n = name.toLowerCase().trim();
      const base = [n];

      // CB - Carte Bancaire
      if (n === 'cb' || n === 'carte bancaire' || n === 'cartebancaire') {
        return [...new Set([...base, 'cb', 'carte', 'carte bancaire', 'carte bleue', 'cartebleue', 'cartebancaire', 'visa', 'mastercard', 'card'])];
      }
      // TR - Ticket Restaurant
      if (n === 'tr' || n === 'ticket' || n === 'ticket resto' || n === 'ticketresto' || n === 'ticket restaurant') {
        return [...new Set([...base, 'tr', 'ticket', 'tickets', 'ticket resto', 'ticket restaurant', 'ticketresto', 'ticketrestaurant'])];
      }
      // ESP - Esp√®ces
      if (n === 'esp' || n === 'especes' || n === 'esp√®ces' || n === 'cash') {
        return [...new Set([...base, 'esp', 'esp√®ces', 'especes', 'espece', 'cash', 'liquide', 'liquid'])];
      }
      // DEP - D√©penses
      if (n === 'dep' || n === 'depenses' || n === 'd√©penses' || n === 'depense' || n === 'd√©pense') {
        return [...new Set([...base, 'dep', 'd√©pense', 'depense', 'd√©penses', 'depenses', 'frais'])];
      }
      // RAZ - Remise √† z√©ro / Caisse
      if (n === 'raz' || n === 'caisse' || n === 'z') {
        return [...new Set([...base, 'raz', 'caisse', 'z', 'fond de caisse', 'recette', 'recettes'])];
      }
      // TOTAL
      if (n === 'total' || n === 'tot') {
        return [...new Set([...base, 'total', 'tot', 'somme'])];
      }

      return base;
    }

    // Validation des conflits de mots-cl√©s/aliases
    function checkKeywordConflict(value, excludeIndex = -1) {
      const normalized = value.trim().toLowerCase();
      if (!normalized) return null;

      for (let j = 0; j < keywords.length; j++) {
        if (j === excludeIndex) continue;
        const kw = keywords[j];

        // Conflit avec un nom de mot-cl√© existant
        if (kw.nom && kw.nom.toLowerCase() === normalized) {
          return { type: 'keyword', name: kw.nom };
        }

        // Conflit avec un alias existant
        if (kw.aliases) {
          for (const alias of kw.aliases) {
            if (alias.toLowerCase() === normalized) {
              return { type: 'alias', name: kw.nom, alias: alias };
            }
          }
        }
      }
      return null;
    }

    function updKw(i, f, v) {
      if (f === 'nom') {
        // Limite √† 20 caract√®res max
        v = v.substring(0, 20).toUpperCase();

        // V√©rifier les conflits (sauf avec soi-m√™me)
        const conflict = checkKeywordConflict(v, i);
        if (conflict) {
          if (conflict.type === 'keyword') {
            toast(`"${v}" existe d√©j√†`, true);
          } else {
            toast(`"${v}" est d√©j√† un alias de ${conflict.name}`, true);
          }
          render(); // Revenir √† la valeur pr√©c√©dente
          return;
        }

        keywords[i].nom = v;
        // Utiliser les aliases par d√©faut si disponibles
        keywords[i].aliases = getDefaultAliases(v);
      }
      else if (f === 'colonne') {
        // Avertir si on change une colonne d√©j√† configur√©e (donn√©es existantes)
        const oldCol = keywords[i].colonne;
        if (oldCol && oldCol !== v && v) {
          const confirmed = confirm(
            `‚ö†Ô∏è Attention !\n\n` +
            `Tu changes la colonne de "${keywords[i].nom}" de ${oldCol} vers ${v}.\n\n` +
            `Si tu as d√©j√† des donn√©es en colonne ${oldCol}, elles ne seront plus utilis√©es.\n\n` +
            `Pour un fichier propre, utilise "Nouveau fichier" en bas de page.\n\n` +
            `Continuer quand m√™me ?`
          );
          if (!confirmed) {
            render();
            return;
          }
        }
        keywords[i].colonne = v;
      }
      else {
        keywords[i][f] = v;
      }
      render();
      markAsModified();
    }
    function delKw(i) { keywords.splice(i, 1); render(); markAsModified(); }

    // Aliases
    function showAliasInput(i) {
      document.getElementById('alias-add-' + i).style.display = 'none';
      const input = document.getElementById('alias-input-' + i);
      input.style.display = 'inline-block';
      input.focus();
    }

    function addAlias(i) {
      const input = document.getElementById('alias-input-' + i);
      const value = input.value.trim().toLowerCase();
      input.value = '';
      input.style.display = 'none';
      document.getElementById('alias-add-' + i).style.display = 'inline-flex';

      if (value && value.length <= 20) {
        if (!keywords[i].aliases) keywords[i].aliases = [];

        // Ne pas ajouter si c'est le nom de la colonne actuelle
        if (value === keywords[i].nom.toLowerCase()) {
          return;
        }

        // Ne pas ajouter si d√©j√† pr√©sent dans ce mot-cl√©
        const existing = keywords[i].aliases.map(a => a.toLowerCase());
        if (existing.includes(value)) {
          toast(`"${value}" est d√©j√† ajout√©`, true);
          return;
        }

        // V√©rifier les conflits avec d'autres mots-cl√©s
        const conflict = checkKeywordConflict(value, i);
        if (conflict) {
          if (conflict.type === 'keyword') {
            toast(`"${value}" est d√©j√† le mot-cl√© ${conflict.name}`, true);
          } else {
            toast(`"${value}" est d√©j√† un alias de ${conflict.name}`, true);
          }
          return;
        }

        keywords[i].aliases.push(value);
        render();
        markAsModified();
      }
    }

    function delAlias(i, j) {
      // Filtrer les aliases qui ne sont pas le nom lui-m√™me
      const filteredAliases = (keywords[i].aliases || []).filter(a => a && a.toLowerCase() !== keywords[i].nom.toLowerCase());
      filteredAliases.splice(j, 1);
      keywords[i].aliases = filteredAliases;
      render();
      markAsModified();
    }

    // Rules
    function addRule() { rules.push({ terms: [{ name: '', op: '+' }, { name: '', op: '+' }], target: '' }); render(); markAsModified(); }
    function delRule(i) { rules.splice(i, 1); render(); markAsModified(); }
    function updRuleTerm(ri, ti, field, value) { rules[ri].terms[ti][field] = value; render(); markAsModified(); }
    function updRuleTarget(ri, value) { rules[ri].target = value; render(); markAsModified(); }
    function addRuleTerm(ri) { rules[ri].terms.push({ name: '', op: '+' }); render(); markAsModified(); }
    function delRuleTerm(ri, ti) {
      if (rules[ri].terms.length > 2) {
        rules[ri].terms.splice(ti, 1);
        // S'assurer que le premier terme est toujours '+'
        if (rules[ri].terms.length > 0) rules[ri].terms[0].op = '+';
        render();
        markAsModified();
      }
    }

    // Auto-save silencieux avec debounce
    let autoSaveTimeout = null;

    function markAsModified() {
      hasUnsavedChanges = true;

      // Annuler le pr√©c√©dent timeout si existe
      if (autoSaveTimeout) clearTimeout(autoSaveTimeout);

      // Auto-save apr√®s 1.5s d'inactivit√©
      autoSaveTimeout = setTimeout(() => {
        autoSave();
      }, 1500);
    }

    async function autoSave() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        toast('Session expir√©e', true);
        return;
      }

      const validKw = keywords.filter(k => k.nom.trim());
      const validRules = rules.filter(r => r.terms.some(t => t.name) && r.target);

      const newCfg = {
        ...(config?.excel_config || {}),
        colonnes_a_remplir: validKw.map(k => ({
          nom: k.nom,
          colonne: k.colonne || null,
          noteColumn: k.noteColumn || null,
          aliases: k.aliases.length ? k.aliases : [k.nom.toLowerCase()]
        })),
        regles_calcul: validRules.map(r => ({
          terms: r.terms.filter(t => t.name),
          target: r.target
        })),
        export_settings: exportSettings
      };

      const { error } = await supabaseClient.from('module_configs').update({
        config: newCfg,
        updated_at: new Date().toISOString()
      }).eq('user_id', session.user.id).eq('module_name', 'compta');

      if (error) {
        toast('Erreur sauvegarde: ' + error.message, true);
        return;
      }

      // Succ√®s silencieux
      if (config) config.excel_config = newCfg;
      hasUnsavedChanges = false;
      toast('‚úì Sauvegard√©');
    }


    // Toggle envoi automatique
    function toggleAutoExport() {
      const toggle = document.getElementById('auto-export-toggle');
      const dot = document.getElementById('toggle-dot');
      const settings = document.getElementById('auto-export-settings');

      if (toggle.checked) {
        dot.classList.add('toggle-dot-active');
        dot.previousElementSibling.classList.add('toggle-active');
        settings.style.display = 'block';
      } else {
        dot.classList.remove('toggle-dot-active');
        dot.previousElementSibling.classList.remove('toggle-active');
        settings.style.display = 'none';
      }
      saveAutoExportSettings();
    }

    // Sauvegarder les settings d'export
    async function saveAutoExportSettings() {
      // Collecter les colonnes coch√©es
      const checkedCols = [];
      document.querySelectorAll('.export-col-checkbox:checked').forEach(cb => {
        checkedCols.push(cb.dataset.col);
      });

      exportSettings = {
        auto_export_enabled: document.getElementById('auto-export-toggle').checked,
        export_email: document.getElementById('export-email').value,
        auto_export_day: document.getElementById('auto-export-day').value,
        auto_export_format: document.getElementById('auto-export-format').value,
        export_columns: checkedCols,
        require_telegram_confirm: true,
        notif_monthly_recap: document.getElementById('notif-monthly-recap').checked,
        notif_weekly_recap: document.getElementById('notif-weekly-recap').checked,
        notif_records: document.getElementById('notif-records').checked,
        notif_objective: document.getElementById('notif-objective').checked,
        monthly_objective: parseInt(document.getElementById('monthly-objective').value) || 0
      };
      markAsModified();
    }

    function saveNotificationSettings() {
      saveAutoExportSettings();
    }

    function toggleObjectiveInput() {
      const checked = document.getElementById('notif-objective').checked;
      document.getElementById('objective-input-row').style.display = checked ? 'block' : 'none';
    }

    function updatePreview() {
      const tgEl = document.getElementById('preview-tg');
      const sheetEl = document.getElementById('preview-sheet');
      const rulesEl = document.getElementById('preview-rules');

      // 1. G√©n√©rer des valeurs coh√©rentes pour Telegram et Excel
      const activeKeywords = keywords.filter(k => k.nom && k.colonne);

      if (activeKeywords.length === 0) {
        tgEl.innerHTML = '<span class="empty-state">Configure tes mots-cl√©s</span>';
        sheetEl.innerHTML = '<span class="empty-state">Configure tes mots-cl√©s</span>';
        rulesEl.style.display = 'none';
        return;
      }

      // Valeurs exemples coh√©rentes
      const exampleValues = [200, 150, 100, 80, 60, 50];
      const keywordValues = {};
      activeKeywords.forEach((k, i) => {
        keywordValues[k.nom] = exampleValues[i] || 50;
      });

      // Calculer les valeurs des r√®gles
      const calculatedValues = {};
      rules.forEach(r => {
        if (r.target && r.terms.some(t => t.name)) {
          let result = 0;
          r.terms.forEach(t => {
            if (t.name && keywordValues[t.name] !== undefined) {
              if (t.op === '-') {
                result -= keywordValues[t.name];
              } else {
                result += keywordValues[t.name];
              }
            }
          });
          if (result !== 0) {
            calculatedValues[r.target] = result;
            keywordValues[r.target] = result; // Pour les r√®gles cha√Æn√©es
          }
        }
      });

      // Message Telegram (seulement les keywords saisis, pas les calculs)
      const examples = activeKeywords.slice(0, 3).map(k => ({
        nom: k.nom.toLowerCase(),
        val: exampleValues[activeKeywords.indexOf(k)] || 50
      }));
      const exampleMsg = examples.map(e => `${e.nom} ${e.val}`).join(' ');
      tgEl.innerHTML = `<div class="tg-bubble">${exampleMsg}</div>`;

      // Excel avec les m√™mes valeurs + colonnes calcul√©es
      const allColumns = [...activeKeywords];

      // Ajouter les colonnes calcul√©es qui ont une valeur
      Object.keys(calculatedValues).forEach(target => {
        const kw = keywords.find(k => k.nom === target);
        if (kw && kw.colonne && !allColumns.find(c => c.nom === target)) {
          allColumns.push(kw);
        }
      });

      const headerCells = allColumns.map(k => `<span>${k.colonne}</span>`).join('');
      const valueCells = allColumns.map(k => {
        const isCalculated = calculatedValues[k.nom] !== undefined;
        const val = isCalculated ? calculatedValues[k.nom] : (keywordValues[k.nom] || '-');
        const style = isCalculated ? 'class="calculated"' : '';
        return `<span ${style}>${val}</span>`;
      }).join('');
      const labelCells = allColumns.map(k => {
        const displayName = k.nom.length > 8 ? k.nom.substring(0, 7) + '‚Ä¶' : k.nom;
        const isCalculated = calculatedValues[k.nom] !== undefined;
        const bgColor = isCalculated ? '#e8f5e9' : '#f5f5f5';
        return `<span title="${k.nom}" style="background:${bgColor};color:#666;font-size:9px;">${displayName}</span>`;
      }).join('');

      sheetEl.innerHTML = `
        <div class="mini-excel-wrapper">
          <div class="mini-excel-container">
            <div class="mini-excel">
              <div class="mini-excel-header">${headerCells}</div>
              <div class="mini-excel-row">${valueCells}</div>
              <div class="mini-excel-row" style="border-top:1px solid #e0e0e0;">${labelCells}</div>
            </div>
          </div>
        </div>
      `;

      // Afficher le d√©tail des r√®gles si il y en a
      const validRules = rules.filter(r => r.target && r.terms.some(t => t.name));
      if (validRules.length > 0) {
        rulesEl.style.display = 'block';
        rulesEl.innerHTML = validRules.map(r => {
          const formula = r.terms.filter(t => t.name).map((t, i) =>
            (i > 0 ? ` ${t.op} ` : '') + t.name
          ).join('');
          const result = calculatedValues[r.target] || '?';
          return `<strong>${r.target}</strong> = ${formula} ‚Üí <span style="color:#4ade80">${result}</span>`;
        }).join(' ¬∑ ');
      } else {
        rulesEl.style.display = 'none';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatNumber(n) {
      if (n === undefined || n === null || n === 0) return '-';
      // Limiter √† 10000 et formater sans notation scientifique
      if (n > 10000) n = 10000;
      // Arrondir √† 2 d√©cimales si n√©cessaire
      if (n % 1 !== 0) n = Math.round(n * 100) / 100;
      return n.toLocaleString('fr-FR');
    }

    // Scroll du mini Excel
    function scrollExcel(direction) {
      const container = document.getElementById('excel-container');
      if (!container) return;
      const scrollAmount = 120;
      container.scrollLeft += direction * scrollAmount;
      setTimeout(() => updateExcelNavVisibility(), 100);
    }

    function updateExcelNavVisibility() {
      const container = document.getElementById('excel-container');
      if (!container) return;
      const leftBtn = document.querySelector('.excel-nav.left');
      const rightBtn = document.querySelector('.excel-nav.right');

      const canScroll = container.scrollWidth > container.clientWidth + 5;
      const atStart = container.scrollLeft < 5;
      const atEnd = container.scrollLeft >= container.scrollWidth - container.clientWidth - 5;

      // Fl√®che gauche : visible si pas au d√©but
      if (leftBtn) {
        if (canScroll && !atStart) {
          leftBtn.classList.add('visible');
        } else {
          leftBtn.classList.remove('visible');
        }
      }

      // Fl√®che droite : visible si pas √† la fin et scroll possible
      if (rightBtn) {
        if (canScroll && !atEnd) {
          rightBtn.classList.add('visible');
        } else {
          rightBtn.classList.remove('visible');
        }
      }
    }


    function toast(msg, err = false) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast show' + (err ? ' error' : '');
      setTimeout(() => t.className = 'toast', 2500);
    }

    function resetConfig() {
      const modal = document.createElement('div');
      modal.id = 'reset-modal';
      modal.innerHTML = `
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;">
          <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 24px; max-width: 320px; text-align: center;">
            <div style="font-size: 32px; margin-bottom: 12px;">üîÑ</div>
            <div style="font-size: 16px; font-weight: 600; color: white; margin-bottom: 8px;">Nouveau fichier ?</div>
            <div style="font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 20px;">Ta config actuelle sera supprim√©e et tu pourras cr√©er un nouveau fichier iArmy.</div>
            <div style="display: flex; gap: 10px;">
              <button onclick="document.getElementById('reset-modal').remove()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: rgba(255,255,255,0.7); font-size: 13px; cursor: pointer;">Annuler</button>
              <button onclick="doResetConfig()" style="flex: 1; padding: 12px; background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); border-radius: 10px; color: #f87171; font-size: 13px; font-weight: 600; cursor: pointer;">Supprimer</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function doResetConfig() {
      document.getElementById('reset-modal')?.remove();
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) return;
      await supabaseClient.from('module_configs').delete().eq('user_id', session.user.id).eq('module_name', 'compta');
      window.location.href = './setup/';
    }

    async function exportDataManual() {
      if (!config?.sheet_id) { toast('Aucun fichier configur√©', true); return; }

      const month = document.getElementById('export-month').value;
      const format = document.getElementById('export-format-manual').value;
      const year = document.getElementById('export-year').value;
      const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
      const sheetName = monthNames[parseInt(month) - 1] + ' ' + year;
      const filename = `compta_${sheetName.replace(' ', '_')}`;

      toast('Export en cours...');

      try {
        const { data: { session }, error: sessionError } = await supabaseClient.auth.refreshSession();
        if (sessionError || !session?.access_token) {
          toast('Session expir√©e, reconnecte-toi', true);
          return;
        }

        if (format === 'xlsx') {
          // Pour Excel, on lit les donn√©es puis on g√©n√®re le fichier
          const res = await fetch(SUPABASE_URL + '/functions/v1/read-google-sheet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.access_token, 'apikey': SUPABASE_ANON_KEY },
            body: JSON.stringify({ sheetId: config.sheet_id, sheetName: sheetName })
          });
          const result = await res.json();
          if (!result.success) throw new Error(result.error || 'Erreur lors de la lecture');

          const rows = result.data;
          if (!rows || rows.length === 0) {
            toast('Aucune donn√©e pour ce mois', true);
            return;
          }

          // Charger SheetJS si pas d√©j√† charg√©
          if (typeof XLSX === 'undefined') {
            toast('Chargement de la librairie Excel...');
            await loadScript('https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js');
          }
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet(rows);
          XLSX.utils.book_append_sheet(wb, ws, sheetName);
          XLSX.writeFile(wb, `${filename}.xlsx`);

        } else if (format === 'pdf') {
          // Pour PDF, on utilise directement generate-pdf (export natif Google)
          const pdfRes = await fetch(SUPABASE_URL + '/functions/v1/generate-pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.access_token, 'apikey': SUPABASE_ANON_KEY },
            body: JSON.stringify({
              sheetId: config.sheet_id,
              sheetName: sheetName,
              title: `Compta - ${sheetName}`
            })
          });

          if (!pdfRes.ok) {
            const errText = await pdfRes.text();
            console.error('PDF error:', errText);
            throw new Error('Impossible de g√©n√©rer le PDF');
          }

          const blob = await pdfRes.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${filename}.pdf`;
          a.click();
          URL.revokeObjectURL(url);
        }

        toast('Export termin√© !');
      } catch (err) {
        console.error('Export error:', err);
        toast('Erreur: ' + err.message, true);
      }
    }

    async function previewExport() {
      if (!config?.sheet_id) { toast('Aucun fichier configur√©', true); return; }

      const month = document.getElementById('export-month').value;
      const year = document.getElementById('export-year').value;
      const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
      const sheetName = monthNames[parseInt(month) - 1] + ' ' + year;

      toast('Chargement de la pr√©visualisation...');

      try {
        // Refresh session to get fresh token
        const { data: { session }, error: sessionError } = await supabaseClient.auth.refreshSession();

        if (sessionError || !session?.access_token) {
          console.error('Session error:', sessionError);
          toast('Session expir√©e, reconnecte-toi', true);
          setTimeout(() => location.href = '../../', 1500);
          return;
        }

        console.log('Session OK, token length:', session.access_token.length);

        console.log('Calling generate-pdf with:', { sheetId: config.sheet_id, sheetName });

        const pdfRes = await fetch(SUPABASE_URL + '/functions/v1/generate-pdf', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({
            sheetId: config.sheet_id,
            sheetName: sheetName,
            title: `Compta - ${sheetName}`
          })
        });

        console.log('Response status:', pdfRes.status);

        if (!pdfRes.ok) {
          const errText = await pdfRes.text();
          console.error('PDF error response:', errText);
          try {
            const err = JSON.parse(errText);
            throw new Error(err.error || 'Impossible de g√©n√©rer le PDF');
          } catch {
            throw new Error(errText || 'Impossible de g√©n√©rer le PDF');
          }
        }

        const blob = await pdfRes.blob();
        const url = URL.createObjectURL(blob);

        // Ouvrir dans un nouvel onglet
        window.open(url, '_blank');

        toast('PDF ouvert dans un nouvel onglet');
      } catch (err) {
        console.error('Preview error:', err);
        toast('Erreur: ' + err.message, true);
      }
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
  <script src="../../js/analytics.js"></script>
</body>
</html>
