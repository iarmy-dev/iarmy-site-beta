<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connexion en cours... - iArmy</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23FF6B35'/><text x='50' y='68' font-family='Arial' font-size='55' font-weight='bold' fill='white' text-anchor='middle'>i</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #030303; color: white; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .container { text-align: center; }
    .logo { width: 100px; height: 100px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 28px; display: flex; align-items: center; justify-content: center; font-size: 52px; font-weight: 800; margin: 0 auto 32px; animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .title { font-size: 24px; font-weight: 600; margin-bottom: 12px; }
    .subtitle { font-size: 14px; color: rgba(255,255,255,0.5); margin-bottom: 32px; }
    .dots { display: flex; gap: 12px; justify-content: center; }
    .dot { width: 12px; height: 12px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 50%; animation: bounce 1.4s ease-in-out infinite; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }
    .error { background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.3); border-radius: 12px; padding: 16px 24px; color: #ef4444; margin-top: 24px; display: none; }
    .error.show { display: block; }
    .btn { background: linear-gradient(135deg, #FF6B35, #FF8B5E); padding: 12px 24px; border-radius: 12px; font-weight: 600; border: none; color: white; cursor: pointer; margin-top: 16px; text-decoration: none; display: inline-block; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">i</div>
    <h1 class="title" id="title">Connexion en cours...</h1>
    <p class="subtitle" id="subtitle">Veuillez patienter</p>
    <div class="dots" id="dots">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
    <div class="error" id="error"></div>
  </div>

  <script>
    console.log('[CALLBACK] üöÄ OAuth callback init');

    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5cWZucGRjbmlmYXVod2dldGNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4ODY1MTIsImV4cCI6MjA4MzQ2MjUxMn0.1W2OaRb0sApMvrG_28AoV2zUFAzrptzpwbR1c65tOPo';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function showError(message) {
      document.getElementById('title').textContent = 'Erreur de connexion';
      document.getElementById('subtitle').textContent = message;
      document.getElementById('dots').style.display = 'none';
      const errorDiv = document.getElementById('error');
      errorDiv.innerHTML = message + '<br><a href="../" class="btn">Retour</a>';
      errorDiv.classList.add('show');
    }

    function showSuccess(name) {
      document.getElementById('title').textContent = `Bienvenue ${name} !`;
      document.getElementById('subtitle').textContent = 'Redirection...';
    }

    async function handleCallback() {
      try {
        // R√©cup√©rer le hash de l'URL (contient access_token, refresh_token, etc.)
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token');

        console.log('[CALLBACK] Hash params:', {
          hasAccessToken: !!accessToken,
          hasRefreshToken: !!refreshToken
        });

        // Si pas de tokens dans le hash, v√©rifier si on a d√©j√† une session
        if (!accessToken || !refreshToken) {
          console.log('[CALLBACK] Pas de tokens dans URL, v√©rification session existante...');

          const { data: { session }, error } = await supabaseClient.auth.getSession();

          if (session) {
            console.log('[CALLBACK] ‚úÖ Session existante trouv√©e:', session.user.email);
            const firstName = session.user.user_metadata?.full_name?.split(' ')[0] ||
                            session.user.user_metadata?.name?.split(' ')[0] ||
                            session.user.email?.split('@')[0] || 'toi';
            showSuccess(firstName);

            // Cr√©er profil si n√©cessaire
            await createProfileIfNeeded(session.user);

            setTimeout(() => { window.location.href = '../modules/compta/setup/'; }, 1500);
            return;
          }

          // Pas de session, pas de tokens ‚Üí erreur
          console.log('[CALLBACK] ‚ùå Aucun token et aucune session');
          showError('Aucun token de connexion trouv√©. Veuillez r√©essayer.');
          return;
        }

        // On a des tokens, on configure la session
        console.log('[CALLBACK] üîê Configuration de la session avec les tokens...');

        const { data, error } = await supabaseClient.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken
        });

        if (error) {
          console.error('[CALLBACK] ‚ùå Erreur setSession:', error);
          showError('Erreur lors de la configuration de la session: ' + error.message);
          return;
        }

        if (!data.session) {
          console.error('[CALLBACK] ‚ùå Pas de session apr√®s setSession');
          showError('Session non cr√©√©e. Veuillez r√©essayer.');
          return;
        }

        const user = data.session.user;
        console.log('[CALLBACK] ‚úÖ Session cr√©√©e:', user.email);

        // Nettoyer l'URL (supprimer le hash)
        window.history.replaceState({}, document.title, window.location.pathname);

        const firstName = user.user_metadata?.full_name?.split(' ')[0] ||
                         user.user_metadata?.name?.split(' ')[0] ||
                         user.email?.split('@')[0] || 'toi';

        showSuccess(firstName);

        // Cr√©er profil si n√©cessaire
        await createProfileIfNeeded(user);

        // Redirection vers la page compta
        setTimeout(() => { window.location.href = '../modules/compta/setup/'; }, 1500);

      } catch (err) {
        console.error('[CALLBACK] ‚ùå Erreur inattendue:', err);
        showError('Une erreur inattendue est survenue: ' + err.message);
      }
    }

    async function createProfileIfNeeded(user) {
      try {
        const { error } = await supabaseClient
          .from('profiles')
          .select('id')
          .eq('id', user.id)
          .single();

        if (error && error.code === 'PGRST116') {
          console.log('[CALLBACK] üìù Cr√©ation du profil...');
          await supabaseClient.from('profiles').insert({
            id: user.id,
            email: user.email,
            name: user.user_metadata?.full_name || user.user_metadata?.name || user.email?.split('@')[0],
            plan: 'free'
          });
          console.log('[CALLBACK] ‚úÖ Profil cr√©√©');
        }
      } catch (e) {
        console.log('[CALLBACK] Profil d√©j√† existant ou erreur ignor√©e');
      }
    }

    // Lancer le traitement au chargement
    document.addEventListener('DOMContentLoaded', handleCallback);
  </script>
</body>
</html>
